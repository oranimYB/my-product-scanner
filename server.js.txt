// server.js
require('dotenv').config();
const express = require('express');
const multer = require('multer');
const axios = require('axios');
const { google } = require('googleapis');
const fs = require('fs');

const app = express();
const upload = multer({ dest: 'uploads/' });

// === é…ç½®é˜¿é‡Œäº‘ OCR ===
const ALIYUN_OCR_URL = 'https://ocr.cn-shanghai.aliyuncs.com/';
const ALIYUN_ACCESS_KEY_ID = process.env.ALIYUN_ACCESS_KEY_ID;
const ALIYUN_ACCESS_KEY_SECRET = process.env.ALIYUN_ACCESS_KEY_SECRET;

// === é…ç½® Google Sheets ===
const SHEETS_ID = process.env.GOOGLE_SHEETS_ID; // ä» URL ä¸­è·å–
const SCOPES = ['https://www.googleapis.com/auth/spreadsheets'];

// è·å–è®¤è¯å®¢æˆ·ç«¯
async function getSheetsClient() {
  const auth = new google.auth.GoogleAuth({
    keyFile: 'credentials.json', // ä¸‹è½½è‡ª Google Cloud Console
    scopes: SCOPES,
  });
  const client = await auth.getClient();
  return google.sheets({ version: 'v4', auth: client });
}

// ä¸Šä¼ å›¾ç‰‡åˆ°é˜¿é‡Œäº‘ OSSï¼ˆæ­¤å¤„ç®€åŒ–ä¸ºæœ¬åœ°è·¯å¾„ï¼Œå®é™…åº”ä¸Šä¼ OSSï¼‰
// å®é™…é¡¹ç›®ä¸­å»ºè®®ä½¿ç”¨ ali-oss SDK

app.post('/api/query', upload.single('image'), async (req, res) => {
  try {
    const imagePath = req.file.path;
    const imageBuffer = fs.readFileSync(imagePath);
    const imageBase64 = Buffer.from(imageBuffer).toString('base64');

    // è°ƒç”¨é˜¿é‡Œäº‘ OCR
    const ocrRes = await axios.post(ALIYUN_OCR_URL, {
      Action: "RecognizeGeneralText",
      Version: "2019-12-30",
      ImageUrl: "", // æˆ–ä¼  Base64
      ImageBase64: imageBase64
    }, {
      headers: {
        'Authorization': `Bearer ${ALIYUN_ACCESS_KEY_ID}:${ALIYUN_ACCESS_KEY_SECRET}`,
        'Content-Type': 'application/json'
      }
    });

    const textItems = ocrRes.data.Data?.Results || [];
    const fullText = textItems.map(t => t.Text).join('\n');

    // TODO: è¿™é‡ŒåŠ å…¥ä½ çš„äº§å“æ•°æ®åº“åŒ¹é…é€»è¾‘
    const codeMatch = fullText.match(/([A-Z0-9]{8,})/); // ç¤ºä¾‹æ­£åˆ™æå–ä»£ç 
    const code = codeMatch ? codeMatch[1] : null;
    const description = "æ™ºèƒ½æ¸©æ§ä¿æ¸©æ¯ 500ml ä¸é”ˆé’¢æè´¨"; // ç¤ºä¾‹
    const link = "https://item.jd.com/123456789.html";

    // å†™å…¥ Google Sheets
    const sheets = await getSheetsClient();
    await sheets.spreadsheets.values.append({
      spreadsheetId: SHEETS_ID,
      range: 'è®°å½•!A1',
      valueInputOption: 'RAW',
      resource: {
        values: [
          [
            new Date().toISOString().slice(0, 19).replace('T', ' '), // æ—¶é—´æˆ³
            req.ip || 'unknown',
            'å¾…ä¸Šä¼ OSSé“¾æ¥', // åç»­æ›¿æ¢ä¸ºçœŸå®OSSé“¾æ¥
            code || '',
            description,
            link,
            ocrRes.data.Data?.Confidence?.toFixed(2) || 0.85,
            'æˆåŠŸ',
            req.headers['user-agent'].includes('Mobile') ? 'æ‰‹æœº' : 'PC',
            'ä¸­å›½æŸåŸå¸‚' // å¯æ¥å…¥ IP å®šä½ API è¡¥å……
          ]
        ]
      }
    });

    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    fs.unlinkSync(imagePath);

    // è¿”å›ç»“æœç»™å‰ç«¯
    res.json({
      code: code,
      description: description,
      link: link
    });

  } catch (err) {
    console.error(err.message);
    res.status(500).json({ error: "è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•" });
  }
});

app.use(express.static('.')); // æ‰˜ç®¡é™æ€æ–‡ä»¶

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ğŸš€ æœåŠ¡è¿è¡Œåœ¨ http://localhost:${PORT}`);
});
app.get('/', (req, res) => {
  res.send('ğŸ“¸ Product Scan API is running!');
});